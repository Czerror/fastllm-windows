name: Build Windows Release

on:
  # æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      build_cpu:
        description: 'Build CPU version'
        type: boolean
        default: true
      build_cuda:
        description: 'Build CUDA version'
        type: boolean
        default: true
      cuda_arch:
        description: 'CUDA architectures (semicolon separated)'
        type: string
        default: '75;80;86;89;90;120'
  
  # è¢« sync-upstream å·¥ä½œæµè°ƒç”¨
  workflow_call:
    inputs:
      build_cpu:
        description: 'Build CPU version'
        type: boolean
        default: true
      build_cuda:
        description: 'Build CUDA version'
        type: boolean
        default: true
      cuda_arch:
        description: 'CUDA architectures (semicolon separated)'
        type: string
        default: '75;80;86;89;90;120'

env:
  BUILD_TYPE: Release

jobs:
  build-cpu:
    name: Build CPU Version
    runs-on: windows-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_cpu }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2  # è‡ªåŠ¨ä½¿ç”¨ v2.x æœ€æ–°ç‰ˆæœ¬
    
    - name: Setup Python
      uses: actions/setup-python@v5  # è‡ªåŠ¨ä½¿ç”¨ v5.x æœ€æ–°ç‰ˆæœ¬
      with:
        python-version: '3.11'
    
    - name: Get version from setup.py
      id: version
      shell: bash
      run: |
        VERSION=$(sed -n 's/.*version\s*=\s*"\([^"]*\)".*/\1/p' tools/scripts/setup.py)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Detected version: ${VERSION}"
    
    - name: Configure CMake (CPU)
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DUSE_MMAP=ON `
          -DUSE_SENTENCEPIECE=ON `
          -DBUILD_CLI=ON `
          -DPY_API=ON
    
    - name: Build (CPU Release)
      run: |
        cd build
        cmake --build . --config Release --parallel 4
    
    - name: Prepare Release Package (CPU)
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        mkdir -p release-cpu/bin
        mkdir -p release-cpu/ftllm
        mkdir -p release-cpu/web
        mkdir -p release-cpu/docs
        
        # Copy executables
        cp build/Release/*.exe release-cpu/bin/
        
        # Copy Python module (.pyd)
        cp build/Release/*.pyd release-cpu/ftllm/ || true
        
        # Copy VC++ runtime
        if [ -d "runtime_libs/vcrt" ]; then
          cp runtime_libs/vcrt/*.dll release-cpu/bin/
        fi
        
        # Copy Python tools
        cp -r build/tools/ftllm/* release-cpu/ftllm/
        
        # Copy ftllm.cmd and install-deps.cmd
        cp tools/fastllm_pytools/ftllm.cmd release-cpu/bin/
        cp tools/fastllm_pytools/install-deps.cmd release-cpu/bin/
        cp tools/fastllm_pytools/requirements.txt release-cpu/ftllm/
        
        # Generate __init__.py with correct version
        cat > release-cpu/ftllm/__init__.py << EOF
        __all__ = ["llm"]

        try:
            from importlib.metadata import version
            __version__ = version("ftllm")
        except:
            try:
                __version__ = version("ftllm-rocm")
            except:
                __version__ = "${VERSION}"
        EOF
        
        # Copy web resources
        cp -r example/webui/web/* release-cpu/web/
        
        # Copy docs (exclude ä½¿ç”¨è¯´æ˜Ž.md for root)
        find docs -name "*.md" ! -name "ä½¿ç”¨è¯´æ˜Ž.md" -exec cp {} release-cpu/docs/ \;
        cp README*.md release-cpu/docs/
        
        # Copy ä½¿ç”¨è¯´æ˜Ž.md to root
        if [ -f "docs/ä½¿ç”¨è¯´æ˜Ž.md" ]; then
          cp docs/ä½¿ç”¨è¯´æ˜Ž.md release-cpu/
        fi
    
    - name: Upload CPU Artifact
      uses: actions/upload-artifact@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        name: fastllm-win-x64-cpu-${{ steps.version.outputs.version }}
        path: release-cpu/
        retention-days: 30

  build-cuda:
    name: Build CUDA Version
    runs-on: windows-latest
    needs: build-cpu  # ç­‰å¾… CPU ç‰ˆæœ¬å®ŒæˆåŽå†ç¼–è¯‘ï¼Œé¿å…å¹¶å‘èµ„æºç«žäº‰
    if: ${{ always() && (github.event_name != 'workflow_dispatch' || inputs.build_cuda) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2  # è‡ªåŠ¨ä½¿ç”¨ v2.x æœ€æ–°ç‰ˆæœ¬
    
    - name: Setup Python
      uses: actions/setup-python@v5  # è‡ªåŠ¨ä½¿ç”¨ v5.x æœ€æ–°ç‰ˆæœ¬
      with:
        python-version: '3.11'
    
    - name: Get version from setup.py
      id: version
      shell: bash
      run: |
        VERSION=$(sed -n 's/.*version\s*=\s*"\([^"]*\)".*/\1/p' tools/scripts/setup.py)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Detected version: ${VERSION}"
    
    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.30
      id: cuda-toolkit
      with:
        cuda: '13.1.0'
        method: 'local'  # å®Œæ•´å®‰è£…ï¼ŒåŒ…å«æ‰€æœ‰å¤´æ–‡ä»¶
    
    - name: Display CUDA version
      run: |
        echo "CUDA Version: ${{ steps.cuda-toolkit.outputs.cuda }}"
        echo "CUDA Path: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
        nvcc --version
    
    - name: Configure CMake (CUDA)
      run: |
        $cudaArch = "${{ github.event.inputs.cuda_arch || '75;80;86;89;90;120' }}"
        mkdir build-cuda
        cd build-cuda
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DUSE_CUDA=ON `
          -DCUDA_ARCH="$cudaArch" `
          -DUSE_MMAP=ON `
          -DUSE_SENTENCEPIECE=ON `
          -DBUILD_CLI=ON `
          -DPY_API=ON
      env:
        CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
    
    - name: Build (CUDA Release)
      run: |
        cd build-cuda
        cmake --build . --config Release --parallel 2  # å‡å°‘å¹¶è¡Œåº¦é¿å…å†…å­˜ä¸è¶³
    
    - name: Prepare Release Package (CUDA)
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        mkdir -p release-cuda/bin
        mkdir -p release-cuda/ftllm
        mkdir -p release-cuda/web
        mkdir -p release-cuda/docs
        
        # Copy executables
        cp build-cuda/Release/*.exe release-cuda/bin/
        
        # Copy Python module (.pyd)
        cp build-cuda/Release/*.pyd release-cuda/ftllm/ || true
        
        # Copy VC++ runtime
        if [ -d "runtime_libs/vcrt" ]; then
          cp runtime_libs/vcrt/*.dll release-cuda/bin/
        fi
        
        # Copy CUDA runtime DLLs
        CUDA_BIN="${CUDA_PATH}/bin"
        if [ -d "${CUDA_BIN}" ]; then
          cp "${CUDA_BIN}/cublas64_"*.dll release-cuda/bin/ 2>/dev/null || true
          cp "${CUDA_BIN}/cublasLt64_"*.dll release-cuda/bin/ 2>/dev/null || true
          cp "${CUDA_BIN}/cudart64_"*.dll release-cuda/bin/ 2>/dev/null || true
        fi
        
        # For CUDA 13.x, DLLs might be in bin/x64
        CUDA_BIN_X64="${CUDA_PATH}/bin/x64"
        if [ -d "${CUDA_BIN_X64}" ]; then
          cp "${CUDA_BIN_X64}/cublas64_"*.dll release-cuda/bin/ 2>/dev/null || true
          cp "${CUDA_BIN_X64}/cublasLt64_"*.dll release-cuda/bin/ 2>/dev/null || true
          cp "${CUDA_BIN_X64}/cudart64_"*.dll release-cuda/bin/ 2>/dev/null || true
        fi
        
        # Copy Python tools
        cp -r build-cuda/tools/ftllm/* release-cuda/ftllm/
        
        # Copy ftllm.cmd and install-deps.cmd
        cp tools/fastllm_pytools/ftllm.cmd release-cuda/bin/
        cp tools/fastllm_pytools/install-deps.cmd release-cuda/bin/
        cp tools/fastllm_pytools/requirements.txt release-cuda/ftllm/
        
        # Generate __init__.py with correct version
        cat > release-cuda/ftllm/__init__.py << EOF
        __all__ = ["llm"]

        try:
            from importlib.metadata import version
            __version__ = version("ftllm")
        except:
            try:
                __version__ = version("ftllm-rocm")
            except:
                __version__ = "${VERSION}"
        EOF
        
        # Copy web resources
        cp -r example/webui/web/* release-cuda/web/
        
        # Copy docs (exclude ä½¿ç”¨è¯´æ˜Ž.md for root)
        find docs -name "*.md" ! -name "ä½¿ç”¨è¯´æ˜Ž.md" -exec cp {} release-cuda/docs/ \;
        cp README*.md release-cuda/docs/
        
        # Copy ä½¿ç”¨è¯´æ˜Ž.md to root
        if [ -f "docs/ä½¿ç”¨è¯´æ˜Ž.md" ]; then
          cp docs/ä½¿ç”¨è¯´æ˜Ž.md release-cuda/
        fi
      env:
        CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
    
    - name: Upload CUDA Artifact
      uses: actions/upload-artifact@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        name: fastllm-win-x64-cuda-${{ steps.version.outputs.version }}
        path: release-cuda/
        retention-days: 30

  release:
    name: Create Release
    needs: [build-cpu, build-cuda]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout for version
      uses: actions/checkout@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Get version and submodule info
      id: version
      run: |
        VERSION=$(sed -n 's/.*version\s*=\s*"\([^"]*\)".*/\1/p' tools/scripts/setup.py)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
        # èŽ·å–ä¸Šæ¸¸æœ€æ–° commit
        git remote add upstream https://github.com/ztxz16/fastllm.git 2>/dev/null || true
        git fetch upstream --quiet
        UPSTREAM_COMMIT=$(git rev-parse upstream/master 2>/dev/null | cut -c1-7)
        UPSTREAM_DATE=$(git log -1 --format=%cd --date=short upstream/master 2>/dev/null)
        echo "upstream_commit=${UPSTREAM_COMMIT}" >> $GITHUB_OUTPUT
        echo "upstream_date=${UPSTREAM_DATE}" >> $GITHUB_OUTPUT
        
        # èŽ·å–å­æ¨¡å—ç‰ˆæœ¬
        cd third_party/pybind11
        PYBIND11_VERSION=$(git describe --tags 2>/dev/null || git rev-parse --short HEAD)
        echo "pybind11_version=${PYBIND11_VERSION}" >> $GITHUB_OUTPUT
        cd ../..
        
        cd third_party/sentencepiece
        SENTENCEPIECE_VERSION=$(git describe --tags 2>/dev/null || git rev-parse --short HEAD)
        echo "sentencepiece_version=${SENTENCEPIECE_VERSION}" >> $GITHUB_OUTPUT
        cd ../..
        
        # èŽ·å–å½“å‰ tag ä¸Žä¸Šä¸€ä¸ª tag ä¹‹é—´çš„æäº¤
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -n "$PREV_TAG" ]; then
          COMMITS=$(git log --oneline ${PREV_TAG}..HEAD --no-merges -- . ':!.github' 2>/dev/null | head -20)
        else
          COMMITS=$(git log --oneline -20 --no-merges -- . ':!.github' 2>/dev/null)
        fi
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        UPSTREAM_COMMIT="${{ steps.version.outputs.upstream_commit }}"
        UPSTREAM_DATE="${{ steps.version.outputs.upstream_date }}"
        PYBIND11="${{ steps.version.outputs.pybind11_version }}"
        SENTENCEPIECE="${{ steps.version.outputs.sentencepiece_version }}"
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        
        cat > release_notes.md << EOF
        ## FastLLM Windows ${TAG_NAME}
        
        Windows é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼Œå¼€ç®±å³ç”¨ï¼Œæ— éœ€ç¼–è¯‘çŽ¯å¢ƒã€‚
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        | æ–‡ä»¶ | è¯´æ˜Ž |
        |------|------|
        | \`fastllm-win-x64-cpu-*.zip\` | CPU ç‰ˆæœ¬ (æ— éœ€ GPU) |
        | \`fastllm-win-x64-cuda-*.zip\` | CUDA ç‰ˆæœ¬ (éœ€è¦ NVIDIA GPU) |
        
        ### ðŸ”§ ç‰ˆæœ¬ä¿¡æ¯
        
        | ç»„ä»¶ | ç‰ˆæœ¬ |
        |------|------|
        | FastLLM | ${VERSION} |
        | ä¸Šæ¸¸åŒæ­¥ | [${UPSTREAM_COMMIT}](https://github.com/ztxz16/fastllm/commit/${UPSTREAM_COMMIT}) (${UPSTREAM_DATE}) |
        | pybind11 | ${PYBIND11} |
        | sentencepiece | ${SENTENCEPIECE} |
        | CUDA Toolkit | 13.1.0 |
        | ç¼–è¯‘å™¨ | MSVC 2022 |
        
        ### ðŸ“ æ›´æ–°å†…å®¹
        
        \`\`\`
        ${{ steps.version.outputs.commits }}
        \`\`\`
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        
        1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ ZIP æ–‡ä»¶
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. è¿è¡Œ \`bin/install-deps.cmd\` å®‰è£… Python ä¾èµ–
        4. è¿è¡Œ \`bin/ftllm.cmd\` å¯åŠ¨ WebUI
        
        è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒ [README](https://github.com/Czerror/fastllm-windows#readme)
        EOF
        
        echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT
    
    - name: Download CPU artifact
      uses: actions/download-artifact@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        name: fastllm-win-x64-cpu-${{ steps.version.outputs.version }}
        path: fastllm-win-x64-cpu-release
      continue-on-error: true
    
    - name: Download CUDA artifact
      uses: actions/download-artifact@v4  # è‡ªåŠ¨ä½¿ç”¨ v4.x æœ€æ–°ç‰ˆæœ¬
      with:
        name: fastllm-win-x64-cuda-${{ steps.version.outputs.version }}
        path: fastllm-win-x64-cuda-release
      continue-on-error: true
    
    - name: Create ZIP archives
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        [ -d "fastllm-win-x64-cpu-release" ] && zip -r "fastllm-win-x64-cpu-v${VERSION}.zip" fastllm-win-x64-cpu-release
        [ -d "fastllm-win-x64-cuda-release" ] && zip -r "fastllm-win-x64-cuda-v${VERSION}.zip" fastllm-win-x64-cuda-release
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2  # è‡ªåŠ¨ä½¿ç”¨ v2.x æœ€æ–°ç‰ˆæœ¬
      with:
        files: |
          fastllm-win-x64-cpu-*.zip
          fastllm-win-x64-cuda-*.zip
        draft: false
        prerelease: false
        body_path: release_notes.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cleanup old releases (keep latest 2)
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 2
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
