name: Sync Upstream

on:
  schedule:
    # 每天 UTC 0:00 (北京时间 8:00) 自动同步
    - cron: '0 0 * * *'
  workflow_dispatch:  # 支持手动触发

permissions:
  contents: write

jobs:
  sync:
    name: Sync with upstream
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/ztxz16/fastllm.git || true
        git fetch upstream
    
    - name: Sync upstream to dev branch
      id: sync_dev
      run: |
        # 同步纯净的上游代码到 dev 分支
        echo "=== Syncing upstream to dev branch ==="
        
        # 检查 dev 分支是否存在（不存在时，从本仓库默认分支创建，避免首次 push 引入 workflow 变更而被拒绝）
        git fetch origin dev || true
        if git show-ref --verify --quiet refs/remotes/origin/dev; then
          git checkout dev
          git pull origin dev
        else
          DEFAULT_BRANCH=$(git symbolic-ref --short refs/remotes/origin/HEAD | sed 's@^origin/@@')
          git fetch origin "$DEFAULT_BRANCH"
          git checkout -b dev "origin/$DEFAULT_BRANCH"
        fi

        BEFORE_COMMIT=$(git rev-parse HEAD)

        # 合并上游 master（优先采用上游变更），但保留本仓库的 workflows，避免 GITHUB_TOKEN 推送被拒
        git merge -X theirs upstream/master -m "chore: sync upstream/master" || true
        git checkout --ours .github/workflows || true
        git add .github/workflows || true

        # 若 merge 进入冲突状态，直接用 'theirs' 解决全量冲突，再把 workflows 回滚为 ours
        if git ls-files -u | grep -q .; then
          echo "Merge conflicts detected; auto-resolving (theirs, except workflows=ours)"
          git checkout --theirs .
          git checkout --ours .github/workflows || true
          git add -A
          git commit -m "chore: sync upstream/master"
        else
          # 非冲突场景下：可能是 fast-forward（无需提交），也可能是仅 workflows 被回滚导致有待提交的变更
          if ! git diff --cached --quiet || ! git diff --quiet; then
            git add -A
            git commit -m "chore: sync upstream/master" || true
          fi
        fi

        AFTER_COMMIT=$(git rev-parse HEAD)
        if [ "$BEFORE_COMMIT" != "$AFTER_COMMIT" ]; then
          git push -u origin dev
          echo "dev_synced=true" >> $GITHUB_OUTPUT
          echo "✅ dev branch synced to upstream/master (workflows preserved)"
        else
          echo "dev_synced=false" >> $GITHUB_OUTPUT
          echo "ℹ️ dev branch already up to date with upstream"
        fi
    
    - name: Update submodules on master
      id: submodules
      run: |
        echo "=== Checking submodule updates on master ==="
        
        git checkout master
        git pull origin master
        
        # 更新子模块到远程最新版本
        git submodule update --remote --merge
        
        # 检查是否有变更
        if git diff --quiet; then
          echo "Submodules are up to date"
          echo "updated=false" >> $GITHUB_OUTPUT
        else
          echo "Submodules updated"
          git add .
          git commit -m "chore: Auto-update submodules (pybind11, sentencepiece)"
          git push origin master
          echo "updated=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create sync summary
      run: |
        echo "=== Sync Summary ==="
        echo "• dev branch: upstream code (for review/testing)"
        echo "• master branch: production code (submodules only)"
    
    outputs:
      dev_synced: ${{ steps.sync_dev.outputs.dev_synced }}
      submodules_updated: ${{ steps.submodules.outputs.updated }}

  # 子模块更新时触发构建（仅构建，不发布）
  trigger-build:
    name: Trigger Build (no release)
    needs: sync
    if: needs.sync.outputs.submodules_updated == 'true'
    uses: ./.github/workflows/build-windows.yml
    with:
      build_cpu: true
      build_cuda: true
    secrets: inherit
