name: Build macOS Release

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      build_intel:
        description: 'Build Intel (x64) version'
        type: boolean
        default: true
      build_arm:
        description: 'Build Apple Silicon (arm64) version'
        type: boolean
        default: true

env:
  BUILD_TYPE: Release

jobs:
  build-intel:
    name: Build Intel (x64) Version
    runs-on: macos-13  # Intel runner
    if: ${{ inputs.build_intel }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew install cmake ninja
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Get version from setup.py
      id: version
      run: |
        VERSION=$(sed -n 's/.*version\s*=\s*"\([^"]*\)".*/\1/p' tools/scripts/setup.py)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Detected version: ${VERSION}"
    
    - name: Configure CMake (Intel)
      run: |
        mkdir build
        cd build
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DUSE_MMAP=ON \
          -DUSE_SENTENCEPIECE=ON \
          -DBUILD_CLI=ON \
          -DPY_API=ON
    
    - name: Build (Intel Release)
      run: |
        cd build
        ninja -j$(sysctl -n hw.ncpu)
    
    - name: Prepare Release Package (Intel)
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        mkdir -p release-intel/bin
        mkdir -p release-intel/ftllm
        mkdir -p release-intel/web
        mkdir -p release-intel/docs
        mkdir -p release-intel/lib
        
        # Copy main executable to root
        cp build/ftllm release-intel/
        
        # Copy other executables to bin/
        for exe in build/*; do
          if [ -x "$exe" ] && [ -f "$exe" ] && [ "$(basename "$exe")" != "ftllm" ]; then
            # Check if it's a Mach-O executable
            if file "$exe" | grep -q "Mach-O"; then
              cp "$exe" release-intel/bin/
            fi
          fi
        done
        
        # Copy shared libraries (dylib)
        cp build/*.dylib release-intel/lib/ 2>/dev/null || true
        cp build/tools/ftllm/*.so release-intel/ftllm/ 2>/dev/null || true
        cp build/tools/ftllm/*.dylib release-intel/ftllm/ 2>/dev/null || true
        
        # Copy Python tools from source (exclude root __init__.py; it will be generated)
        while IFS= read -r -d '' srcFile; do
          relPath="${srcFile#tools/fastllm_pytools/}"
          if [ "$relPath" = "__init__.py" ]; then
            continue
          fi
          mkdir -p "release-intel/ftllm/$(dirname "$relPath")"
          cp "$srcFile" "release-intel/ftllm/$relPath"
        done < <(find tools/fastllm_pytools -type f -print0)
        
        # Generate __init__.py with correct version
        printf '%s\n' \
          '__all__ = ["llm"]' \
          '' \
          'try:' \
          '    from importlib.metadata import version' \
          '    __version__ = version("ftllm")' \
          'except:' \
          '    try:' \
          '        __version__ = version("ftllm-rocm")' \
          '    except:' \
          '        __version__ = "'"${VERSION}"'"' \
          > release-intel/ftllm/__init__.py
        
        # Copy __main__.py for python -m ftllm (keep identical to source)
        cp tools/fastllm_pytools/__main__.py release-intel/ftllm/__main__.py
        
        # Copy web resources
        cp -r example/webui/web/* release-intel/web/
        
        # Copy docs (only top-level docs/*.md; exclude 使用说明.md for root)
        for md in docs/*.md; do
          if [ "$(basename "$md")" != "使用说明.md" ]; then
            cp "$md" release-intel/docs/
          fi
        done
        cp README*.md release-intel/docs/
        
        # Copy 使用说明.md to root
        if [ -f "docs/使用说明.md" ]; then
          cp docs/使用说明.md release-intel/
        fi
        
        # Create run script
        printf '%s\n' \
          '#!/bin/bash' \
          'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' \
          'export DYLD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${DYLD_LIBRARY_PATH}"' \
          '"${SCRIPT_DIR}/ftllm" "$@"' \
          > release-intel/run.sh
        chmod +x release-intel/run.sh
        chmod +x release-intel/ftllm
    
    - name: Upload Intel Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fastllm-macos-x64-${{ steps.version.outputs.version }}
        path: release-intel/
        retention-days: 30

  build-arm:
    name: Build Apple Silicon (arm64) Version
    runs-on: macos-14  # Apple Silicon runner
    if: ${{ inputs.build_arm }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew install cmake ninja
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Get version from setup.py
      id: version
      run: |
        VERSION=$(sed -n 's/.*version\s*=\s*"\([^"]*\)".*/\1/p' tools/scripts/setup.py)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Detected version: ${VERSION}"
    
    - name: Configure CMake (Apple Silicon)
      run: |
        mkdir build
        cd build
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DUSE_MMAP=ON \
          -DUSE_SENTENCEPIECE=ON \
          -DBUILD_CLI=ON \
          -DPY_API=ON
    
    - name: Build (Apple Silicon Release)
      run: |
        cd build
        ninja -j$(sysctl -n hw.ncpu)
    
    - name: Prepare Release Package (Apple Silicon)
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        mkdir -p release-arm/bin
        mkdir -p release-arm/ftllm
        mkdir -p release-arm/web
        mkdir -p release-arm/docs
        mkdir -p release-arm/lib
        
        # Copy main executable to root
        cp build/ftllm release-arm/
        
        # Copy other executables to bin/
        for exe in build/*; do
          if [ -x "$exe" ] && [ -f "$exe" ] && [ "$(basename "$exe")" != "ftllm" ]; then
            # Check if it's a Mach-O executable
            if file "$exe" | grep -q "Mach-O"; then
              cp "$exe" release-arm/bin/
            fi
          fi
        done
        
        # Copy shared libraries (dylib)
        cp build/*.dylib release-arm/lib/ 2>/dev/null || true
        cp build/tools/ftllm/*.so release-arm/ftllm/ 2>/dev/null || true
        cp build/tools/ftllm/*.dylib release-arm/ftllm/ 2>/dev/null || true
        
        # Copy Python tools from source (exclude root __init__.py; it will be generated)
        while IFS= read -r -d '' srcFile; do
          relPath="${srcFile#tools/fastllm_pytools/}"
          if [ "$relPath" = "__init__.py" ]; then
            continue
          fi
          mkdir -p "release-arm/ftllm/$(dirname "$relPath")"
          cp "$srcFile" "release-arm/ftllm/$relPath"
        done < <(find tools/fastllm_pytools -type f -print0)
        
        # Generate __init__.py with correct version
        printf '%s\n' \
          '__all__ = ["llm"]' \
          '' \
          'try:' \
          '    from importlib.metadata import version' \
          '    __version__ = version("ftllm")' \
          'except:' \
          '    try:' \
          '        __version__ = version("ftllm-rocm")' \
          '    except:' \
          '        __version__ = "'"${VERSION}"'"' \
          > release-arm/ftllm/__init__.py
        
        # Copy __main__.py for python -m ftllm (keep identical to source)
        cp tools/fastllm_pytools/__main__.py release-arm/ftllm/__main__.py
        
        # Copy web resources
        cp -r example/webui/web/* release-arm/web/
        
        # Copy docs (only top-level docs/*.md; exclude 使用说明.md for root)
        for md in docs/*.md; do
          if [ "$(basename "$md")" != "使用说明.md" ]; then
            cp "$md" release-arm/docs/
          fi
        done
        cp README*.md release-arm/docs/
        
        # Copy 使用说明.md to root
        if [ -f "docs/使用说明.md" ]; then
          cp docs/使用说明.md release-arm/
        fi
        
        # Create run script
        printf '%s\n' \
          '#!/bin/bash' \
          'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' \
          'export DYLD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${DYLD_LIBRARY_PATH}"' \
          '"${SCRIPT_DIR}/ftllm" "$@"' \
          > release-arm/run.sh
        chmod +x release-arm/run.sh
        chmod +x release-arm/ftllm
    
    - name: Upload Apple Silicon Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fastllm-macos-arm64-${{ steps.version.outputs.version }}
        path: release-arm/
        retention-days: 30

  # 创建 Universal Binary (可选)
  build-universal:
    name: Create Universal Binary
    runs-on: macos-14
    needs: [build-intel, build-arm]
    if: ${{ always() && needs.build-intel.result == 'success' && needs.build-arm.result == 'success' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Get version from setup.py
      id: version
      run: |
        VERSION=$(sed -n 's/.*version\s*=\s*"\([^"]*\)".*/\1/p' tools/scripts/setup.py)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Download Intel Artifact
      uses: actions/download-artifact@v4
      with:
        name: fastllm-macos-x64-${{ steps.version.outputs.version }}
        path: intel
    
    - name: Download Apple Silicon Artifact
      uses: actions/download-artifact@v4
      with:
        name: fastllm-macos-arm64-${{ steps.version.outputs.version }}
        path: arm
    
    - name: Create Universal Binary
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        mkdir -p universal/bin
        mkdir -p universal/ftllm
        mkdir -p universal/web
        mkdir -p universal/docs
        mkdir -p universal/lib
        
        # Create universal binary for ftllm executable
        if [ -f "intel/ftllm" ] && [ -f "arm/ftllm" ]; then
          lipo -create intel/ftllm arm/ftllm -output universal/ftllm
          chmod +x universal/ftllm
        fi
        
        # Create universal binaries for executables in bin/
        for exe in intel/bin/*; do
          name=$(basename "$exe")
          if [ -f "arm/bin/$name" ]; then
            lipo -create "intel/bin/$name" "arm/bin/$name" -output "universal/bin/$name" 2>/dev/null || cp "$exe" "universal/bin/$name"
            chmod +x "universal/bin/$name"
          fi
        done
        
        # Create universal binaries for libraries
        for lib in intel/lib/*; do
          name=$(basename "$lib")
          if [ -f "arm/lib/$name" ]; then
            lipo -create "intel/lib/$name" "arm/lib/$name" -output "universal/lib/$name" 2>/dev/null || cp "$lib" "universal/lib/$name"
          fi
        done
        
        # Copy Python files (architecture independent)
        cp -r arm/ftllm/* universal/ftllm/ 2>/dev/null || true
        
        # Copy other resources
        cp -r arm/web/* universal/web/ 2>/dev/null || true
        cp -r arm/docs/* universal/docs/ 2>/dev/null || true
        cp arm/使用说明.md universal/ 2>/dev/null || true
        
        # Create run script
        printf '%s\n' \
          '#!/bin/bash' \
          'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' \
          'export DYLD_LIBRARY_PATH="${SCRIPT_DIR}/lib:${DYLD_LIBRARY_PATH}"' \
          '"${SCRIPT_DIR}/ftllm" "$@"' \
          > universal/run.sh
        chmod +x universal/run.sh
    
    - name: Upload Universal Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fastllm-macos-universal-${{ steps.version.outputs.version }}
        path: universal/
        retention-days: 30
